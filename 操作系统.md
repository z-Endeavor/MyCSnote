# 操作系统



## 基本功能

1. **进程管理**，其工作主要是进程调度，在单用户单任务的情况下，处理器仅为一个用户的一个任务所独占， 进程管理的工作十分简单。但在多道程序或多用户的情况 下，组织多个作业或任务时，就要解决处理器的调度、 分配和回收等问题 。
2. **存储管理**：存储分配、存储共享、存储保护 、存储扩张。
3. **设备管理**：设备分配、设备传输控制 、设备独立性。
4. **文件管理**：文件存储空间的管理、目录管理 、文件操作管理、文件保护。
5. **作业管理**：负责处理用户提交的任何要求。



## 磁盘调度算法

磁盘调度在多道程序设计的计算机系统中，各个进程可能会不断提出不同的对磁盘进行读/写操作的请求。由于有时候这些进程的发送请求的速度比磁盘响应的还要快，因此我们有必要为每个磁盘设备建立一个等待队列，常用的磁盘调度算法有以下四种：

#### 1、先来先服务算法（FIFS)

根据**进程请求访问磁盘的先后次序**进行调度。

- 优点：公平、简单，且每个进程的请求都能依次得到处理，不会出现某一进程的请求长期得不到满足的情况，各进程得到服务的响应时间的变化幅度较小。
- 缺点：由于未对寻道进行优化，在对磁盘的访问请求比较多的情况下，此算法将降低设备服务的吞吐量，致使平均寻道时间可能较长。

#### 2、最短寻道时间优先算法（SSTF）

要求**访问的磁道与当前磁头所在的磁道距离最近**，以使每次的寻道时间最短。

- 优点：可以得到比较好的吞吐量，但却不能保证平均寻道时间最短。
- 缺点：对用户的服务请求的响应机会不是均等的，因而导致响应时间的变化幅度很大。在服务请求很多的情况下，对内外边缘磁道的请求将会无限期的被延迟，有些请求的响应时间将不可预期。

#### 3、扫描算法（SCAN）

不仅考虑到欲访问的磁道与当前磁道的距离，更**优先考虑的是磁头的当前移动方向**。例如，当磁头正在自里向外移动时，扫描算法所选择的下一个访问对象应是其欲访问的磁道既在当前磁道之外，又是距离最近的。这样自里向外地访问，直到再无更外的磁道需要访问才将磁臂换向，自外向里移动。由于这种算法中磁头移动的规律颇似电梯的运行，故又称为<u>电梯调度算法</u>。

- 优点：基本上克服了最短寻道时间优先算法的服务集中于中间磁道和响应时间变化比较大的缺点，而具有SSTF的优点即吞吐量较大，平均响应时间较小，
- 缺点：但由于是摆动式的扫描方法，两侧磁道被访问的频率仍低于中间磁道。

#### 4、循环扫描算法（CSCAN）

循环扫描算法是对扫描算法的改进。如果对磁道的访问请求是均匀分布的，当磁头到达磁盘的一端，并反向运动时落在磁头之后的访问请求相对较少。这是由于这些磁道刚被处理，而磁盘另一端的请求密度相当高，且这些访问请求等待的时间较长，为了解决这种情况，循环扫描算法**规定磁头单向移动**。例如，只自里向外移动，当磁头移到最外的被访问磁道时，磁头立即返回到最里的欲访磁道，即将最小磁道号紧接着最大磁道号构成循环，进行扫描。



> 假定某磁盘共有200个柱面，编号为0-199，如果在为访问143号柱面的请求者服务后，当前正在为访问125号柱面的请求服务，同时有若干请求者在等待服务，它们每次要访问的柱面号为  86，147，91，177，94，150，102，175，130
>
> - 先来先服务 （125）86.147.91.177.94.150.102.175.130
> - 最短寻道时间优先（125）130.147.150.175.177.102.94.91.86
> - 电梯调度（125）102.94.91.86.130.147.150.175.177
> - 循环扫描 （125）130.147.150.175.177.86.91.94.102



## 文件的物理结构

操作系统是最接近硬件的系统软件，操作系统的功能之一就是对外设—磁盘的管理，而磁盘中通常存储了一系列文件数据，因此，磁盘管理就是将文件数据在磁盘中分配、组织起来。

将文件数据按照某种规则或以某种数据结构存储在磁盘中，即文件在磁盘中实际存在的物理状态，就是通常所说的文件物理结构。若文件物理结构能让我们在存、取数据时更加方便快捷，就是一个好的物理结构。

#### 1、连续分配

文件在磁盘占有一组**连续**的块，逻辑上相邻的块在物理上也相邻。

- 优点：顺序存取速度快，支持随机访问
- 缺点：会产生碎片，不利于文件拓展

#### 2、链接分配

采取**离散分配**的方式，为文件分配离散的磁盘块。

**（1）隐式链接**：每个磁盘块中有指向下一磁盘块的指针。

**（2）显式链接**：把用于链接文件的物理块指针显式地存放在一张表中，即文件分配表（FAT）。

- 优点：可以解决碎片问题，外存利用率高，文件拓展方便。
- 缺点：只能顺序访问，不能随机访问。指针或文件分配表占用一定存储空间。

#### 3、索引分配

允许文件离散地分配在各个磁盘中，系统**会为每个文件建立一张索引表**，索引表中记录了文件的各个逻辑块对应的物理块（索引表的功能记类似于内存管理中的页表–建立逻辑页面到物理页之间的映射关系）。<u>索引表存放的磁盘块成为索引块，文件数据存放的磁盘块成为数据块</u>。

- 优点：支持随机访问，文件拓展容易
- 缺点：索引表需要占用一定的存储空间



## 进程

进程是**资源分配**的基本单位。

### 三种基本状态

- **运行态：**进程拥有了CPU资源和其他所需资源。
- **就绪态：**进程拥有了其他所需资源，但还没拥有CPU资源。
- **阻塞态：**进程既没有CPU资源也没有其他所需资源。

#### 另外两种状态

- **创建态：**进程正在被创建，操作系统为该进程分配系统资源、初始化PCB。
- **终止态：**进程正在被撤销，操作系统会回收该进程拥有的系统资源、撤销PCB。

#### 进程状态的转换

创建态 => 就绪态：系统完成创建进程相关的工作。

就绪态 => 运行态：进程被调度。

运行态 => 就绪态：时间片到，或CPU被更高优先级的进程抢占。

运行态 => 阻塞态：等待系统资源分配，或等待某事件发生。（主动行为）

阻塞态 => 就绪态：资源分配到位，或等待的事件发生。（被动行为）

运行态 => 终止态：进程运行结束，或运行过程中遇到不可修复的错误。

**导致进程变成阻塞态的事件**

1. 等待资源（临界资源、临界区）
2. 信息交换（I/O输入输出、读写内存）
3. 进程同步（停下来等待其他进程）

### 进程控制原语

为了实现进程控制，在操作系统内核中，有一组程序专门用于完成对进程的控制。系统服务对用户开放，即用户可以通过相应的接口来使用它们。

- **进程创建原语**
  - 从PCB集合中申请一个空白的PCB。
  - 将调用者参数（如进程外部[标识符](https://so.csdn.net/so/search?q=标识符&spm=1001.2101.3001.7020)，初始CPU状态，进程优先数，初始内存及申请资源清单）添入该PCB，设置记账数据。
  - 置新进程为“就绪”态。

- **终止进程原语**
  - 用于终止完成的进程，回收其所占资源。包括消去其资源描述块，消去进程的PCB。
- **阻塞原语**
  - 将进程从运行态变为阻塞态。进程被插入等待事件的队列。
  - 同时修改PCB中相应的表项，如进程状态和等待队列指针。
- **唤醒原语**
  - 将进程从阻塞态变为就绪态。进程从阻塞队列移出，插入就绪队列，等待调度。
  - 同时修改PCB中相应的表项，如进程状态。

### 信号量

#### 本质

信息量的数据结构是一个值和一个指针，指针指向等待该信号量的下一个进程。信号量的值与相应资源的使用情况有关。当它的值大于0时，表示当前可用资源的数量；当它的值小于0时，其绝对值表示等待使用该资源的进程个数。

信号量（Semaphore）是一个整型变量，可以对其执行 down 和 up 操作，也就是常见的 P 和 V 操作。注意，**信号量的值仅能由PV操作来改变**。

#### 功能

进程间通信处理同步互斥的机制。信号量是一个计数器，可以用来控制多个进程对共享资源的访问。它常作为一种**锁机制**，防止某进程正在访问共享资源时，其他进程也访问该资源。

如果信号量的取值只能为 0 或 1 ，那么就成为了**互斥量**，0 表示临界区已加锁，1表示临界区解锁。

### PV操作

PV操作由P操作原语和V操作原语组成（<u>原语是不可中断的过程</u>），针对信号量进行相应的操作。

- **P操作**（down） : 
  - 对信号量执行-1操作。
  - 如果信号量小于 0，则该进程进入阻塞队列。
  - 如果信号量大于等于 0，则该进程继续执行。
- **V操作**（up） ：
  - 对信号量执行 +1 操作。
  - 如果信号量大于0，则该进程继续执行。
  - 如果信号量小于等于0，则释放阻塞队列中的第一个等待信号量的进程。

### 调度算法

1. **时间片轮转调度算法（RR）**

   定义时间片。当正在运行的进程用完了时间片后，即使此进程还要运行，操作系统也不让它继续运行，而是从就绪队列依次选择下一个处于就绪态的进程执行，而被剥夺CPU使用的进程返回到就绪队列的末尾，等待再次被调度。

   **特点：**简单易行、平均响应时间短。此算法不利于处理紧急作业

2. **先来先服务调度算法（FCFS）**

   按就绪队列的先后次序选择进程来执行，直到此进程阻塞或结束，才进行下一次的进程选择调度。

   **特点：**FCFS调度算法利于长作业，不利于短作业。

3. **短作业优先调度算法（SJF）**

   选择就绪队列中确切（或估计）运行时间最短的进程进入执行。

   **特点：**有效降低作业的平均等待时间和提高系统的吞吐量。

4. **最高优先级调度算法（HPF）**

   进程的优先级用于表示进程的重要性及运行的优先性。一个进程的优先级可分为两种：静态优先级和动态优先级。

5. **多级反馈队列调度算法（MLFQ）**

   设置多个就绪队列，并为各个队列赋予不同的优先级。第一个队列的优先级最高，第二队次之，其余队列优先级依次降低。对于同一个队列中的各个进程，按照时间片轮转法调度。

6. **高响应比优先调度算法（HRRF）**

   介于先来先服务算法与最短进程优先算法之间的一种折中算法。

   **特点**：既考虑进程等待时间，又考虑进程的执行时间。 但HRRF调度算法需要每次计算各各个进程的响应比Rp，这会带来较大的时间开销（特别是在就绪进程个数多的情况下）。

   ```
   Rp=（等待时间+预计执行时间）/执行时间=响应时间/执行时间
   ```



## 死锁

### 四个必要条件

在一个系统中一下四个条件同时成立，那么就能引起死锁。

- **互斥**：至少有一个资源必须处于非共享模式，即一次只有一个进程可使用。如果另一进程申请该资源，那么申请进程应等到该资源释放为止。
- **占有和等待**：—个进程应占有至少一个资源，并等待另一个资源，而该资源为其他进程所占有。
- **不可抢占**：已经分配给一个进程的资源不能强制性地被抢占，它只能被占有它的进程显式地释放。
- **环路等待**：有两个或者两个以上的进程组成一条环路，该环路中的每个进程都在等待下一个进程所占有的资源。

> M资源，每个进程最多N个资源，最多几个进程不会发生死锁？
>
> ​		当 `x(n-1)+1≤m` 时，此时不会发生死锁。即 `x ≤ m-1/n-1` 。



## 线程

线程是**独立调度**的基本单位。

一个进程中可以有多个线程，共享进程资源。

### 多线程

多线程是采用一种并发执行机制，把一个处理器划分为若干个短的时间片，每个时间片依次轮流执行处理各个应用程序。把一个程序划分为**若干个子任务并发执行，每一个任务就是一个线程**。

#### 多线程安全

当多个线程访问某个方法时，在多线程环境下，**程序可以始终执行正确的行为，符合预期的逻辑**，则为线程安全。

**产生问题的原因：**

1. **原子性：**一个或者多个操作在 CPU 执行的过程中被中断（读、改、写）
2. **可见性**：一个线程对共享变量的修改，另外一个线程不能立刻看到
3. **有序性**：程序执行的顺序没有按照代码的先后顺序执行（可能动态编译器会对指令进行重排序）

**保障措施：**

​	利用**锁机制**，保证锁内的代码块在同一时刻只能有一个线程执行。

​	通过**同步方法**，定义同步代码块，保障有序性。结合锁机制，保证修改对其他线程的可见性等等。







页式存储 缺页中断



标记守护线程







